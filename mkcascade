#!/bin/sh

set -e

REPO_ROOT_DIR=$(dirname "$SCRIPT")
TARGET_DIR=$REPO_ROOT_DIR/target
HD_PATH=$TARGET_DIR/kernel-hd
CASCADE_DIR=/var/cascade

if [ ! -f $TARGET_DIR/rootfs.tar.gz ]; then
  mkdir -p $TARGET_DIR
  wget -O $TARGET_DIR/rootfs.tar.gz https://distfiles.gentoo.org/releases/amd64/autobuilds/20240526T163557Z/stage3-amd64-openrc-20240526T163557Z.tar.xz
fi
if [ ! -d $CASCADE_DIR/bin ]; then
  sudo mkdir -p $CASCADE_DIR
  sudo tar xpf $TARGET_DIR/rootfs.tar.gz --xattrs-include='*.*' --numeric-owner -C $CASCADE_DIR

  echo "nameserver 8.8.8.8" | sudo dd of=$CASCADE_DIR/etc/resolv.conf
  
  sudo mount --rbind /dev $CASCADE_DIR/dev
  sudo mount --make-rslave $CASCADE_DIR/dev
  sudo mount -t proc /proc $CASCADE_DIR/proc
  sudo mount --rbind /sys $CASCADE_DIR/sys
  sudo mount --make-rslave $CASCADE_DIR/sys
  sudo mount --rbind /tmp $CASCADE_DIR/tmp
  # Gentoo docs specifying mounting /run, but
  # we skip that because configs end up being
  # saved here and we want to copy it to the
  # final disk image, so we don't want anything
  # from the underlying host machine included.
  # sudo mount --bind /run $CASCADE_DIR/run

  # Configure the image
  #
  # Enable the serial console
  sudo sed -i '/ttyS0/s/^#//' $CASCADE_DIR/etc/inittab
  
  echo "
  #!/bin/sh
  
  # This assumes that there aren't any other USE flags
  # set by default.
  echo 'USE="dracut"' > /etc/portage/make.conf

  emerge-webrsync
  emerge sys-kernel/gentoo-kernel-bin
  " | sudo dd of=$CASCADE_DIR/setup
  sudo chmod +x $CASCADE_DIR/setup
  sudo chroot $CASCADE_DIR /setup
  sudo rm $CASCADE_DIR/setup

  sudo umount -lf $CASCADE_DIR/dev
  sudo umount -lf $CASCADE_DIR/proc
  sudo umount -lf $CASCADE_DIR/sys
  sudo umount -lf $CASCADE_DIR/tmp

  # Make disk image
  dd if=/dev/zero of=$HD_PATH bs=1M count=10000
  
  TMP_MNT=/mnt/cascade
  sudo mkdir -p $TMP_MNT
  sudo mkfs.ext4 $HD_PATH
  sudo mount $HD_PATH $TMP_MNT
  sudo cp -r $CASCADE_DIR/* $TMP_MNT
  
  # Create blank root password
  sudo passwd --root $TMP_MNT root -d
  
  sudo umount $TMP_MNT
  unset TMP_MNT
fi

